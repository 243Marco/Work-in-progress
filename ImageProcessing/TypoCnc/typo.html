<div id="svgcontainer"></div>

<script language="javascript" src="clipper.js"></script>

<script language="javascript">

svg = 
'	<path d="M44.3677,53.0732c1.2041,1.3594,2.1265,2.8652,2.7666,4.5156c0.6416,1.6509,0.9614,3.4087,0.9614,5.2725'+
'		c0,2.5239-0.4946,4.8154-1.4844,6.8735c-0.9907,2.0591-2.3887,3.8276-4.1953,5.3027c-1.8057,1.4761-3.9521,2.6216-6.4385,3.437'+
'		c-2.4849,0.8149-5.2231,1.2241-8.2139,1.2241c-2.4468,0-4.4473-0.2529-6.0005-0.7563c-0.5835,0.7368-1.1553,1.4741-1.7183,2.2134'+
'		c-0.564,0.7368-0.8452,1.4937-0.8452,2.2705c0,0.9336,0.5342,1.6606,1.6016,2.1851c1.0684,0.5244,2.3696,0.9229,3.9043,1.1943'+
'		c1.5337,0.2715,3.1558,0.4463,4.8643,0.5244c1.7095,0.0781,3.2236,0.1162,4.5444,0.1162c2.3687,0,4.7285,0.1563,7.0786,0.4668'+
'		c2.3496,0.3105,4.457,0.873,6.3203,1.6904c1.8652,0.8154,3.3799,1.9404,4.5444,3.377c1.166,1.4375,1.7485,3.2842,1.7485,5.5371'+
'		c0,2.1348-0.4961,4.1064-1.4863,5.9111c-0.9902,1.8057-2.2813,3.4482-3.8735,4.9248c-1.5933,1.4746-3.4087,2.7861-5.4473,3.9316'+
'		c-2.04,1.1465-4.1274,2.0986-6.2632,2.8535c-2.1362,0.7588-4.2236,1.332-6.2632,1.7188c-2.0386,0.3887-3.8354,0.584-5.3887,0.584'+
'		c-1.8257,0-3.7676-0.2529-5.8257-0.7588c-2.0586-0.5039-3.9521-1.2627-5.6812-2.2715c-1.728-1.0098-3.1646-2.2617-4.3105-3.7568'+
'		c-1.145-1.4951-1.7188-3.2529-1.7188-5.2715c0-1.2051,0.2041-2.3613,0.6118-3.4688c0.4077-1.1045,0.9414-2.1943,1.6021-3.2637'+
'		c0.6606-1.0664,1.437-2.126,2.3306-3.1748c0.8936-1.0479,1.8252-2.1152,2.7964-3.2031c-0.5444-0.2715-1.0586-0.6416-1.5439-1.1064'+
'		c-0.4854-0.4658-0.9028-0.9805-1.2524-1.5439s-0.6318-1.1377-0.8442-1.7197c-0.2139-0.582-0.3213-1.1445-0.3213-1.6885'+
'		c0-1.2041,0.5435-2.5527,1.6313-4.0483c1.0874-1.4961,2.8745-3.4082,5.3599-5.7397c-2.6797-1.3604-4.7676-3.2437-6.2627-5.6504'+
'		c-1.4956-2.4087-2.2432-5.0874-2.2432-8.04c0-2.4468,0.4956-4.6899,1.4858-6.7285c0.9902-2.0405,2.3887-3.7778,4.1948-5.2144'+
'		c1.8057-1.4375,3.9419-2.5537,6.4082-3.3501c2.4663-0.7974,5.1943-1.1943,8.1855-1.1943c2.3306,0,4.4858,0.2905,6.4658,0.873'+
'		c1.981,0.5835,3.729,1.3789,5.2446,2.3887c3.7671-0.9702,6.7188-1.7085,8.8545-2.2139c2.1367-0.5044,3.4766-0.7573,4.02-0.7573'+
'		c1.0879,0,1.6318,0.5825,1.6318,1.7485c0,0.7373-0.0391,1.4951-0.1162,2.272c-0.0781,0.7764-0.1748,1.6118-0.2925,2.5054'+
'		L44.3677,53.0732z M18.7339,94.9053c-1.0103,1.3984-1.7866,2.6396-2.3315,3.7256c-0.5425,1.0898-0.8149,2.293-0.8149,3.6123'+
'		c0,1.6309,0.5151,3.0107,1.5439,4.1396c1.0298,1.124,2.3306,2.0391,3.9038,2.7344c1.5723,0.7012,3.2715,1.1963,5.0977,1.4883'+
'		c1.8257,0.29,3.5537,0.4355,5.1851,0.4355c1.3208,0,2.7964-0.1348,4.4268-0.4063c1.6318-0.2734,3.147-0.7285,4.5444-1.3701'+
'		c1.3989-0.6416,2.5732-1.4941,3.5254-2.5635c0.9507-1.0674,1.4268-2.418,1.4268-4.0488c0-1.3975-0.4077-2.5146-1.2227-3.3516'+
'		c-0.8154-0.834-1.8745-1.4736-3.1753-1.9199c-1.3008-0.4482-2.7871-0.7383-4.457-0.876c-1.6699-0.1357-3.3403-0.2012-5.0103-0.2012'+
'		c-0.8936,0-1.874-0.0205-2.9419-0.0596s-2.166-0.1152-3.292-0.2324c-1.1265-0.1172-2.2427-0.2637-3.3501-0.4385'+
'		C20.6855,95.3984,19.666,95.1748,18.7339,94.9053z M29.1621,74.9214c1.5142,0,2.8252-0.2725,3.9321-0.8174'+
'		c1.1079-0.5415,2.0098-1.2705,2.71-2.1846c0.6987-0.9106,1.2231-1.98,1.5723-3.2031c0.3491-1.2236,0.5239-2.5156,0.5239-3.874'+
'		c0-1.5542-0.1836-3.0972-0.5532-4.6313c-0.3682-1.5352-0.9419-2.9136-1.7178-4.1367c-0.7773-1.2236-1.7773-2.2046-3.0005-2.9429'+
'		c-1.2236-0.7378-2.6699-1.106-4.3413-1.106c-1.5142,0-2.8149,0.2808-3.9028,0.8442c-1.0874,0.563-1.981,1.3115-2.6797,2.2427'+
'		c-0.7002,0.9331-1.2139,2.021-1.5439,3.2637c-0.3306,1.2417-0.4951,2.5435-0.4951,3.9023c0,1.5156,0.1748,3.0298,0.5239,4.5439'+
'		c0.3496,1.5146,0.9033,2.8745,1.6606,4.0786c0.7568,1.2036,1.7378,2.1753,2.9419,2.9121'+
'		C25.9966,74.5522,27.4531,74.9214,29.1621,74.9214z"/>'+
'	<path d="M62.2529,52.0835c2.0205-0.8154,4.0103-1.5342,5.9722-2.1563c1.9609-0.6206,3.8066-1.1353,5.5347-1.5439'+
'		c1.7285-0.4077,3.3013-0.7183,4.7183-0.9312c1.4185-0.2144,2.5928-0.3208,3.5249-0.3208c2.7964,0,5.1465,0.3208,7.0493,0.9609'+
'		c1.9028,0.6411,3.4385,1.6606,4.6025,3.0581c1.165,1.3984,2,3.1758,2.5054,5.3315s0.7383,4.748,0.6987,7.7778l-0.291,18.9922'+
'		c-0.0391,1.2046,0.0386,2.3306,0.2329,3.3789c0.1948,1.0488,0.4077,2.0791,0.6401,3.0879'+
'		c0.0396,0.0381,0.0601,0.1943,0.0601,0.4658c0,0.584-0.3892,0.9336-1.166,1.0488c-0.5049,0.1172-1.0786,0.2236-1.7188,0.3203'+
'		c-0.6406,0.0986-1.292,0.1748-1.9526,0.2344c-0.6592,0.0557-1.3198,0.0967-1.9795,0.1152'+
'		c-0.6602,0.0186-1.2427,0.0283-1.748,0.0283c-0.4277,0-0.7485-0.1143-0.9614-0.3486c-0.2129-0.2324-0.3779-0.582-0.4956-1.0488'+
'		l-0.7568-2.7959c-1.4756,0.6602-2.9907,1.2725-4.5444,1.835c-1.5527,0.5635-3.0396,1.0488-4.4561,1.4561'+
'		c-1.418,0.4092-2.71,0.7275-3.875,0.9629c-1.1655,0.2314-2.1162,0.3486-2.854,0.3486c-2.0591,0-3.8457-0.3779-5.3599-1.1367'+
'		c-1.5156-0.7568-2.7578-1.709-3.7295-2.8545c-0.9707-1.1465-1.6885-2.4072-2.1553-3.7871'+
'		c-0.4663-1.3799-0.6987-2.6895-0.6987-3.9321c0-2.2144,0.3975-4.0879,1.1938-5.6226c0.7959-1.5337,1.8745-2.8057,3.2339-3.8149'+
'		c1.2041-0.8936,2.6118-1.6318,4.2231-2.2144c1.6123-0.582,3.3887-1.0386,5.3315-1.3687c1.9414-0.3311,4.0391-0.5737,6.2915-0.729'+
'		s4.6216-0.2725,7.1074-0.3491l0.0581-1.9814c0.0391-1.7866-0.0679-3.3882-0.3198-4.8066c-0.2524-1.4165-0.7095-2.6104-1.3696-3.583'+
'		c-0.6602-0.9702-1.5532-1.7085-2.6787-2.2129c-1.1279-0.5054-2.5444-0.7568-4.2544-0.7568c-2.0962,0-4.2817,0.2329-6.5542,0.6987'+
'		c-2.272,0.4658-4.8643,1.1646-7.7769,2.0977L62.2529,52.0835z M86.3726,70.4927c-1.8252,0.1172-3.5342,0.2241-5.127,0.3208'+
'		c-1.5918,0.0977-3.0493,0.2427-4.3696,0.437c-1.3203,0.1953-2.4849,0.4961-3.4946,0.9033'+
'		c-1.0103,0.4082-1.8262,0.981-2.4468,1.7178c-0.4663,0.5439-0.855,1.2246-1.166,2.04c-0.311,0.8149-0.4663,1.7095-0.4663,2.6787'+
'		c0,0.8174,0.1265,1.6514,0.3789,2.5054c0.252,0.8545,0.6997,1.6421,1.3403,2.3608c0.6406,0.7183,1.5049,1.3105,2.5923,1.7764'+
'		c1.0879,0.4658,2.4663,0.6987,4.1372,0.6987c0.2329,0,0.6108-0.0376,1.1348-0.1157c0.5249-0.0781,1.1655-0.2046,1.9229-0.3794'+
'		c0.7578-0.1748,1.6021-0.4175,2.5347-0.728c0.9316-0.3105,1.8838-0.6982,2.8545-1.1636L86.3726,70.4927z"/>'+
'	<path d="M121.7935,51.7339 c1.9434-0.5835,3.8843-1.146,5.8271-1.6899 c1.9414-0.5439,3.7871-1.019,5.5342-1.4268'+
'		c1.748-0.4077,3.3301-0.7378,4.7485-0.9907 c1.4175-0.252,2.5913-0.3784,3.5249-0.3784 c2.2515,0,4.2915,0.6313,6.1157,1.8931'+
'		c1.8262,1.2622,3.3789,2.8843,4.6621,4.8652c1.2813,1.981,2.2715,4.1846,2.9707,6.6118s1.0488,4.7876,1.0488,7.0781'+
'		c0,4.1563-0.748,7.7681-2.2432,10.8369 c-1.4951,3.0674-3.5059,5.6313-6.0303,7.6895 c-2.5244,2.0596-5.4473,3.5928-8.7681,4.6035'+
'		c-3.3203,1.0088-6.8062,1.5146-10.4575,1.5146 c-1.7861,0-3.5825-0.1084-5.3882-0.3223 c-1.8066-0.2119-3.4956-0.5137-5.0684-0.9004'+
'		c-1.5737-0.3906-2.9624-0.835-4.1665-1.3408 c-1.2041-0.5049-2.0977-1.0488-2.6797-1.6318 V23.9443'+
'		c0-2.0591-0.3301-3.4663-0.9902-4.2241 c-0.6606-0.7578-1.7476-1.1362-3.2622-1.1362 c-0.7383,0-1.5347,0.0576-2.3887,0.1743'+
'		l-0.3501-2.7959 c4.2725-1.165,7.7876-1.9897,10.5454-2.4756 c2.7578-0.4854,4.4082-0.7285,4.9521-0.7285'+
'		c1.2427,0,1.8633,0.7002,1.8633,2.0977 V51.7339z'+
'   M121.7935,80.5728c0,1.2808,0.3208,2.3594,0.9619,3.2329'+
'		c0.6406,0.873,1.4468,1.5732,2.418,2.0962c0.9702,0.5249,2.0381,0.9038,3.2041,1.1372c1.1655,0.2324,2.2915,0.3496,3.3784,0.3496'+
'		c9.439,0,14.1582-4.8545,14.1582-14.5654c0-2.2134-0.2627-4.4668-0.7881-6.7573c-0.5234-2.2915-1.2998-4.3701-2.3281-6.2344'+
'		c-1.0303-1.8647-2.293-3.3784-3.7876-4.5444c-1.4956-1.1646-3.2148-1.748-5.1563-1.748c-0.7378,0-2.1948,0.2046-4.3691,0.6123'+
'		c-2.1758,0.4077-4.7393,1.0586-7.6914,1.9521V80.5728z"/>'+
'	<path d="M185.0049,92.3408c-3.2217,0-6.1455-0.5732-8.7676-1.7188c-2.6211-1.1455-4.8828-2.709-6.7871-4.6904'+
'		c-1.9033-1.981-3.3682-4.3208-4.3975-7.0205c-1.0303-2.6982-1.5449-5.6016-1.5449-8.7095c0-3.4175,0.5928-6.5444,1.7773-9.3789'+
'		c1.1836-2.8359,2.8242-5.2534,4.9219-7.2544c2.0977-1.999,4.6035-3.5532,7.5176-4.6602c2.9111-1.1069,6.1162-1.6602,9.6123-1.6602'+
'		c3.2236,0,6.1641,0.5532,8.8262,1.6602c2.6611,1.1069,4.9307,2.6313,6.8164,4.5737c1.8828,1.9414,3.3496,4.2334,4.3975,6.874'+
'		c1.0488,2.6411,1.5732,5.4961,1.5732,8.564c0,3.4961-0.582,6.6904-1.748,9.5845c-1.165,2.8926-2.8066,5.3589-4.9219,7.3975'+
'		c-2.1182,2.0405-4.6426,3.6235-7.5752,4.7495C191.7734,91.7783,188.5391,92.3408,185.0049,92.3408z M187.7432,87.2139'+
'		c2.0977,0,3.8271-0.4561,5.1855-1.3696c1.3594-0.9126,2.4268-2.0869,3.2041-3.5249c0.7764-1.4375,1.3115-3.0483,1.6016-4.835'+
'		c0.292-1.7856,0.4375-3.5347,0.4375-5.2432c0-2.0972-0.2217-4.3115-0.6699-6.6411c-0.4463-2.3306-1.1943-4.4761-2.2432-6.4385'+
'		c-1.0488-1.9619-2.4268-3.582-4.1367-4.8643c-1.709-1.2813-3.8252-1.9233-6.3496-1.9233c-2.0977,0-3.8262,0.4561-5.1855,1.3696'+
'		c-1.3594,0.9131-2.4277,2.0977-3.2031,3.5537c-0.7773,1.4565-1.3203,3.0679-1.6309,4.835'+
'		c-0.3125,1.7686-0.4668,3.5254-0.4668,5.2729c0,2.1362,0.2324,4.3701,0.6992,6.6987c0.4648,2.3315,1.2236,4.4683,2.2725,6.4102'+
'		c1.0479,1.9419,2.4258,3.5444,4.1348,4.8062C183.1025,86.583,185.2188,87.2139,187.7432,87.2139z"/>';

function svgToPaths(svg)
{
  var t = {scalex:17, scaley:17, translatex:0, translatey:-5};
  var i = 0;
  var aux = [];
  svg = svg.split("\n").join("");
  svg = svg.split(" ").join("");
  svg = svg.split("\t").join("");

  do {
    var begin = svg.indexOf("d=", i);
    if ( begin == -1 )
      break;
    var end = svg.indexOf("\"", begin+3);
    if ( end == -1 )
    {
      console.log("Not matched end of string!");
      break;
    }
    tok = svg.substr(begin+3, end-begin-3);
    //console.log(tok);
    i = end + 1;
    var paths = toXYPaths(transform(parsePath(tok), t))
    aux = aux.concat(paths);
//    for (var j=0; j<paths.length; j++)
//      aux.push( j == 0 ? paths[j] : reverse(paths[j]));
  } while (1)
  return aux;
}

var source = svgToPaths(svg);
var path = source;
var result = [];
var base = source;
var tool = 20;

document.getElementById('svgcontainer').innerHTML += "Orig<br>\n";
document.getElementById('svgcontainer').innerHTML += pathToSvg(path) + "<br>\n";

path = expandPath(path, -tool);
for (var i=0; i<12 && path.length; i++)
{
  //console.log("pass "+i);
  for (var j in path)
    result.push(path[j]);

  document.getElementById('svgcontainer').innerHTML += "Pass " + i + "<br>\n";
  //base
  document.getElementById('svgcontainer').innerHTML += pathToSvg(path);
  // expanded
  var pathout = contourPath(path, tool);
  document.getElementById('svgcontainer').innerHTML += pathToSvg(pathout);
  // calc remaining
  path = subtractPath(path, pathout);
}


document.getElementById('svgcontainer').innerHTML += linesToSvg(base, result);
// end


function reverse(arr)
{
  return arr.reverse();
}

function subtractPath(op1, op2)
{
  var subj_paths = ClipperLib.JS.Clone(op1);
  var clip_paths = ClipperLib.JS.Clone(op2);

  var scale = 1000;
  ClipperLib.JS.ScaleUpPaths(subj_paths, scale);
  ClipperLib.JS.ScaleUpPaths(clip_paths, scale);

  var cpr = new ClipperLib.Clipper();
  cpr.AddPaths(subj_paths, ClipperLib.PolyType.ptSubject, true);
  cpr.AddPaths(clip_paths, ClipperLib.PolyType.ptClip, true);

  var subject_fillType = ClipperLib.PolyFillType.pftNonZero;
  var clip_fillType = ClipperLib.PolyFillType.pftNonZero;

  solution_paths = new ClipperLib.Paths();
  cpr.Execute(ClipperLib.ClipType.ctDifference, solution_paths, subject_fillType, clip_fillType);

  ClipperLib.JS.ScaleUpPaths(solution_paths, 1/scale);
//  ClipperLib.JS.ScaleUpPaths(subj_paths, 1/scale);
//  ClipperLib.JS.ScaleUpPaths(clip_paths, 1/scale);

//  for (var v in solution_paths) solution_paths[v].push(solution_paths[v][0]);

  return solution_paths;
}

function unionPath(op1, op2)
{
  var subj_paths = ClipperLib.JS.Clone(op1);
  var clip_paths = ClipperLib.JS.Clone(op2);

  var scale = 1000;
  ClipperLib.JS.ScaleUpPaths(subj_paths, scale);
  ClipperLib.JS.ScaleUpPaths(clip_paths, scale);

  var cpr = new ClipperLib.Clipper();
  cpr.AddPaths(subj_paths, ClipperLib.PolyType.ptSubject, true);
  cpr.AddPaths(clip_paths, ClipperLib.PolyType.ptClip, true);

  var subject_fillType = ClipperLib.PolyFillType.pftNonZero;
  var clip_fillType = ClipperLib.PolyFillType.pftNonZero;

  solution_paths = new ClipperLib.Paths();
  cpr.Execute(ClipperLib.ClipType.ctUnion, solution_paths, subject_fillType, clip_fillType);

  ClipperLib.JS.ScaleUpPaths(solution_paths, 1/scale);
//  ClipperLib.JS.ScaleUpPaths(subj_paths, 1/scale);
//  ClipperLib.JS.ScaleUpPaths(clip_paths, 1/scale);

  return solution_paths;
}

function contourPath(path_, r)
{
  var scale = 100;
  var path = ClipperLib.JS.Clone(path_);
  ClipperLib.JS.ScaleUpPaths(path, scale);
//  ClipperLib.JS.Lighten(path, 1.5 * scale);

  var co = new ClipperLib.ClipperOffset(); 
  var offsetted_paths = new ClipperLib.Paths();
  co.Clear();
  co.AddPaths( path, ClipperLib.JoinType.jtRound, ClipperLib.EndType.etClosedLine);
  co.MiterLimit = 1;
  co.ArcTolerance = 0.25*100;
  co.Execute(offsetted_paths, scale * r);

//  offsetted_paths = ClipperLib.JS.Lighten(offsetted_paths, 0.1 * scale);
  ClipperLib.JS.ScaleUpPaths(offsetted_paths, 1/scale);
//  ClipperLib.JS.ScaleUpPaths(path, 1/scale);
  return offsetted_paths;
}

function expandPath(path_, r)
{
  var scale = 50;
  var path = ClipperLib.JS.Clone(path_);
  ClipperLib.JS.ScaleUpPaths(path, scale);
  path = ClipperLib.JS.Lighten(path, 0.05 * scale);
    /*
  for (var v in path) 
    if ( path[v][0] != path[v][path[v].length-1] )
      path[v].push(path[v][0]);
      */
  var co = new ClipperLib.ClipperOffset(); 
  var offsetted_paths = new ClipperLib.Paths();
  co.Clear();
  co.AddPaths( path, ClipperLib.JoinType.jtRound, ClipperLib.EndType.etClosedPolygon);//(path, ClipperLib.PolyType.ptSubject, true);
  co.MiterLimit = 1;
  co.ArcTolerance = 0.25*100;
  co.Execute(offsetted_paths, scale * r);


//  offsetted_paths = ClipperLib.JS.Lighten(offsetted_paths, 0.1 * scale);
  ClipperLib.JS.ScaleUpPaths(offsetted_paths, 1/scale);
//  ClipperLib.JS.ScaleUpPaths(path, 1/scale);
  return offsetted_paths;
}

function paths2string (paths, scale) {
  var svgpath = "", i, j;
  if (!scale) scale = 1;
  for(i = 0; i < paths.length; i++) 
  {
    for(j = 0; j < paths[i].length; j++)
    {
      if (!j) svgpath += "M";
      else svgpath += "L";
      svgpath += (paths[i][j].X / scale) + "," + (paths[i][j].Y / scale) + " ";
    }
    svgpath += "Z\n";
  }
  if (svgpath=="") svgpath = "M0,0";
  return svgpath;
}

function pathToSvg(path)
{
  return '<svg style="margin-top:10px; margin-right:10px;margin-bottom:10px;background-color:#dddddd" width="800" height="400">' +
    '<path stroke="black" fill="yellow" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + paths2string(path, 0.5*10) + '"/>' +
    '</svg>';
}

function linesToSvg(orig, path)
{
  var d = tool/30*24;
  var r = '<svg style="margin-top:10px; margin-right:10px;margin-bottom:10px;background-color:#ffffff" width="1600" height="800">' +
          '<path stroke="none" fill="rgba(255,255,0,0.8)" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="' + paths2string(orig, 0.5/2*10) + '"/>';
  for (var p in path)
    r +=  '<path stroke="rgba(0,0,255,0.3)" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="'+d+'" d="' + paths2string([path[p]], 0.5/2*10) + '"/>' +
          '<path stroke="black" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="' + paths2string([path[p]], 0.5/2*10) + '"/>';
  r+=     '</svg>';
  return r;
}

function toXYPaths(data)
{
  var paths = [];
  var aux = [];
  var lastAnchor;
  for ( var i in data )
  {
    var cmd = data[i];
    var args = cmd.attributes;
    if ( cmd.type == "M" )
    {
      position = makePos(args[0], args[1]);
      lastAnchor = {X:position.x, Y:position.y};
      aux.push(lastAnchor);
      continue;
    }
    if ( cmd.type == "l" )
    {
      position = addPos(position, makePos(args[0], args[1]));
      aux.push({X:position.x, Y:position.y});
      continue;
    }          
    if ( cmd.type == "L" )
    {
      position = makePos(args[0], args[1]);
      aux.push({X:position.x, Y:position.y});
      continue;        
    }          
    if ( cmd.type == "h" )
    {
      position = addPos(position, makePos(args[0], 0));
      aux.push({X:position.x, Y:position.y});
      continue;
    }
    if ( cmd.type == "v" )
    {
      position = addPos(position, makePos(0, args[0]));
      aux.push({X:position.x, Y:position.y});
      continue;
    }
    if ( cmd.type == "H" )
    {
      position = makePos(args[0], position.y);
      aux.push({X:position.x, Y:position.y});
      continue;
    }
    if ( cmd.type == "V" )
    {
      position = makePos(position.x, args[0]);
      aux.push({X:position.x, Y:position.y});
      continue;
    }          
    if ( cmd.type == "c" )
    {
      var p1 = addPos(position, makePos(args[0], args[1]));
      var p2 = addPos(position, makePos(args[2], args[3]));
      var pn = addPos(position, makePos(args[4], args[5]));

      // position - pn
			for ( var j = 0; j<=8; j++)
      {
        var pt = calcBezier(position, p1, p2, pn, j/8);
        aux.push({X:pt.x, Y:pt.y});
      }
      position = pn;
      continue;
    }          
    if ( cmd.type == "C" )
    {
      var p1 = makePos(args[0], args[1]);
      var p2 = makePos(args[2], args[3]);
      var pn = makePos(args[4], args[5]);

      // position - pn
			for ( var j = 0; j<=8; j++)
      {
        var pt = calcBezier(position, p1, p2, pn, j/8);
        aux.push({X:pt.x, Y:pt.y});
      }
      position = pn;
      continue;
    }          
    if ( cmd.type == "s" )
    {
      var p2 = addPos(position, makePos(args[0], args[1]));
      var pn = addPos(position, makePos(args[2], args[3]));
      var p1 = addPos(position, {x:-pn.x+p2.x, y:-pn.y+p2.y});

      // position - pn
			for ( var j = 0; j<=8; j++)
      {
        var pt = calcBezier(position, p1, p2, pn, j/8);
        aux.push({X:pt.x, Y:pt.y});
      }
      position = pn;
      continue;
    }          
    if ( cmd.type == "z" )
    {
      aux.push(lastAnchor);
      paths.push(aux);
      aux = [];
      continue;
    }          
    console.log("Unknown command <" + cmd.type + ">");
  }
  return paths;
}

function calculateCircleCenter(A, B, C)
{
  var yDelta_a = B.y - A.y; 
  var xDelta_a = B.x - A.x; 
  var yDelta_b = C.y - B.y; 
  var xDelta_b = C.x - B.x; 
  var aSlope = yDelta_a/xDelta_a; 
  var bSlope = yDelta_b/xDelta_b; 
  var center = {x:0, y:0};
  center.x = (aSlope*bSlope*(A.y - C.y) + bSlope*(A.x + B.x) - aSlope*(B.x+C.x) )/(2* (bSlope-aSlope) );
  center.y = -1*(center.x - (A.x+B.x)/2)/aSlope + (A.y+B.y)/2;
  return center;
}

function linear(pt1, pt2, f)
{
  return {x:pt1.x + (pt2.x-pt1.x)*f, y:pt1.y + (pt2.y-pt1.y)*f};
}

function calcBezier(pt1, c1, c2, pt2, f)
{
  var lineA1 = linear(pt1, c1, f);
  var lineA2 = linear(c1, c2, f);
  var lineA3 = linear(c2, pt2, f);
  var lineB1 = linear(lineA1, lineA2, f);
  var lineB2 = linear(lineA2, lineA3, f);
  return linear(lineB1, lineB2, f);
}

function parsePath(path)
{
  var pos = 0, aux = [];
  while (pos < path.length && 
         (token = getToken(path.substr(pos), pos)) && 
         token.length > 0 )
  {
    if ( token.type )
      aux.push(token);
    pos += token.length;
  }
  return aux;
}

function drawPath(data)
{
  for (var i in data)
    processToken(data[i]);
}

function getToken(str, pos)
{
 //d0="M10,10 l10,0 l50,0 l80,0 l0,10 l-60,0 l0,-90";

  var tests = [
    /^([M])([\-]?[\d\.]+)([\-|\,][\d\.]+)/,
    /^([l|L])([\-]?[\d\.]+)[\ \,]*([\-]?[\d\.]+)/,
    /^([h|v|H|V])([\-]?[\d\.]+)/,
    /^([c|C])([\-]?[\d\.]+)([\-|\,][\d\.]+)([\-|\,][\d\.]+)([\-|\,][\d\.]+)([\-|\,][\d\.]+)([\-|\,][\d\.]+)/,
    /^([s|S])([\-]?[\d\.]+)([\-|\,][\d\.]+)([\-|\,][\d\.]+)([\-|\,][\d\.]+)/,
    /^(z)/
  ];

  while ( str[0] == ' ' )
    return {length:1};

  for ( var i in tests )
  {
    var matches = tests[i].exec(str);
    if ( matches && matches.length > 0 )
    {
      var token = matches.splice(0, 1)[0];
      var type = matches.splice(0, 1)[0];
      for ( var i in matches )
      {
        if ( matches[i][0] == "," )
          matches[i] = matches[i].substr(1);
        matches[i] = parseFloat(matches[i]);
      }
      return {type:type, length:token.length, attributes:matches};
    }
  }
  console.log("Unknown command 1 <" + str[0] + ">" + str.substring(1));
} 

function makePos(x, y)
{
  return {x:x, y:y};
}
function scalePos(p)
{
  return {x:p.x*2+20, y:p.y*2+20};
}
function scaleGPos(p)
{
  return {x:p.x*2+20, y:-p.y*2+20};
}
function addPos(p1, p2)
{
  return {x:p1.x+p2.x, y:p1.y+p2.y};
}

function transform(data, t)
{
  var aux = [];
  for ( var i in data )
  {
    var token = data[i];
    if ( typeof(token.type) == "undefined" )
      continue;

    if (token.attributes.length % 2 == 1 ) 
    {
      if (token.type == "H" )
        token.attributes[0] = token.attributes[0] * t.scalex + t.translatex;
      else
      if (token.type == "V" )
        token.attributes[0] = (token.attributes[0] + t.translatey) * t.scaley;
      else
      if (token.type == "h" )
        token.attributes[0] = token.attributes[0] * t.scalex;
      else
      if (token.type == "v" )
        token.attributes[0] = token.attributes[0] * t.scaley;
      else
        console.log("Unknown single argument token " + token.type);
    } else
    if ( token.type == token.type.toUpperCase() )
    {
      for (var j=0; j<token.attributes.length; j+=2)
      {
        token.attributes[j+0] = (token.attributes[j+0] + t.translatex) * t.scalex;
        token.attributes[j+1] = (token.attributes[j+1] + t.translatey) * t.scaley;
      }
    } else
    {
      for (var j=0; j<token.attributes.length; j+=2)
      {
        token.attributes[j+0] = token.attributes[j+0] * t.scalex;
        token.attributes[j+1] = token.attributes[j+1] * t.scaley;
      }
    }
    aux.push(token);
  }
  return aux;
}

</script>